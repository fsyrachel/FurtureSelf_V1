# API æ¥å£æ–‡æ¡£ 

## ğŸ“˜ æ–‡æ¡£è¯´æ˜

- **ç‰ˆæœ¬**: v1.5 
- **åŸºç¡€æ¶æ„**: System Architecture v1.7
- **æ•°æ®åº“**: DB Schema v1.3 


## ğŸŒ åŸºç¡€ä¿¡æ¯

### Base URL
- **å¼€å‘ç¯å¢ƒ**: `http://localhost:8000/api/v1`
- **ç”Ÿäº§ç¯å¢ƒ**: `https://your-api.onrender.com/api/v1`

### è®¤è¯æ–¹å¼
- **P1 é˜¶æ®µ**: åŒ¿å UUID (å­˜å‚¨åœ¨å‰ç«¯ localStorage)
- **ä¼ é€’æ–¹å¼**: Query Parameter `user_id` æˆ– Request Body

### Content-Type
- `application/json`

### å­—ç¬¦ç¼–ç 
- `UTF-8`

---

## ğŸ“‹ å…¨å±€å“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "data": { ... },
  "timestamp": "2024-11-09T12:34:56Z"
}
```

### é”™è¯¯å“åº”
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "é”™è¯¯æè¿°",
    "details": { ... }
  },
  "timestamp": "2024-11-09T12:34:56Z"
}
```

### HTTP çŠ¶æ€ç 

| çŠ¶æ€ç  | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| 200 | OK | è¯·æ±‚æˆåŠŸ |
| 201 | Created | èµ„æºåˆ›å»ºæˆåŠŸ |
| 202 | Accepted | å¼‚æ­¥ä»»åŠ¡å·²æ¥å— |
| 400 | Bad Request | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 403 | Forbidden | ç¦æ­¢è®¿é—®ï¼ˆå¦‚è¶…è¿‡é™åˆ¶ï¼‰ |
| 404 | Not Found | èµ„æºä¸å­˜åœ¨ |
| 500 | Internal Server Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## ğŸ” æ¨¡å—ä¸€ï¼šç”¨æˆ·ä¸è®¤è¯

### 1.1 åˆå§‹åŒ–åŒ¿åç”¨æˆ· (F1.1)

**POST** `/user/init`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- é›¶æ‘©æ“¦åŒ¿åç™»å½•
- æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿›è¡Œè·¯ç”±

#### è¯·æ±‚ä½“
```json
{
  "anonymous_user_id": "uuid-123-abc"  // å¯é€‰ï¼Œå¦‚ä¸ºnullåˆ™åˆ›å»ºæ–°ç”¨æˆ·
}
```

#### å“åº” (200 OK)

**æƒ…å†µ1: æ–°ç”¨æˆ·**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "ONBOARDING"
}
```

**æƒ…å†µ2: å·²æœ‰ç”¨æˆ·**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "ACTIVE"
}
```

#### çŠ¶æ€è¯´æ˜

| Status | å«ä¹‰ | å‰ç«¯è·¯ç”± |
|--------|------|----------|
| ONBOARDING | æ–°ç”¨æˆ·ï¼Œæœªå®Œæˆæ¡£æ¡ˆ | â†’ F2.1 é—®å·é¡µ |
| ACTIVE | å·²å®Œæˆæ¡£æ¡ˆ | â†’ F6.1 é¦–é¡µ |

#### ä¸šåŠ¡é€»è¾‘
1. æ£€æŸ¥ `anonymous_user_id` æ˜¯å¦å­˜åœ¨äºæ•°æ®åº“
2. å¦‚ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·ï¼Œ`status = 'ONBOARDING'`
3. å¦‚å­˜åœ¨ â†’ è¿”å›ç°æœ‰ç”¨æˆ·çŠ¶æ€

---

## ğŸ“ æ¨¡å—äºŒï¼šæ¡£æ¡ˆç®¡ç†

### 2.1 æäº¤å½“å‰æ¡£æ¡ˆ (F2.1) 

**POST** `/profile/current`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- æäº¤4éƒ¨åˆ†æ–°é—®å·ï¼šåŸºæœ¬ä¿¡æ¯ã€ä»·å€¼è§‚(PVQ)ã€äººæ ¼(BFI)
- æ•°æ®å­˜å‚¨åˆ° DB v1.3 çš„4ä¸ªç‹¬ç«‹JSONBå­—æ®µ

#### è¯·æ±‚ä½“ (v1.5 å®Œæ•´ç‰ˆ)
```json
{
  "demo_data": {
    "name": "å¼ ä¸‰",
    "age": 25,
    "gender": "ç”·",
    "status": "ç ”ç©¶ç”Ÿ",
    "field": "è®¡ç®—æœºç§‘å­¦",
    "interests": "äººå·¥æ™ºèƒ½",
    "location": "ä¸Šæµ·",
    "future_location": "æ–°åŠ å¡"
  },
  "vals_data": {
    "self_direction": 5,    // è‡ªä¸»æ€§ (1-5)
    "stimulation": 4,       // åˆºæ¿€æ€§ (1-5)
    "hedonism": 4,          // äº«ä¹ä¸»ä¹‰ (1-5)
    "achievement": 5,       // æˆå°± (1-5)
    "power": 2,             // æƒåŠ› (1-5)
    "security": 5,          // å®‰å…¨ (1-5)
    "conformity": 3,        // é¡ºä» (1-5)
    "tradition": 2,         // ä¼ ç»Ÿ (1-5)
    "benevolence": 4,       // ä»æ…ˆ (1-5)
    "universalism": 5       // æ™®ä¸– (1-5)
  },
  "bfi_data": {
    "extraversion": 4.5,        // å¤–å‘æ€§ (1-5)
    "agreeableness": 3.5,       // å®œäººæ€§ (1-5)
    "conscientiousness": 5.0,   // å°½è´£æ€§ (1-5)
    "neuroticism": 2.0,         // ç¥ç»è´¨ (1-5)
    "openness": 4.0             // å¼€æ”¾æ€§ (1-5)
  },
}
```

#### æ•°æ®éªŒè¯è§„åˆ™

**demo_data éªŒè¯**:
- `name`: å­—ç¬¦ä¸²ï¼Œ1-50å­—ç¬¦
- `age`: æ•´æ•°ï¼Œ18-100
- `gender`: å­—ç¬¦ä¸²ï¼Œéç©º
- `status`: å­—ç¬¦ä¸²ï¼Œéç©º
- `field`: å­—ç¬¦ä¸²ï¼Œéç©º
- `interests`: å­—ç¬¦ä¸²ï¼Œéç©º
- `location`: å­—ç¬¦ä¸²ï¼Œéç©º
- `future_location`: å­—ç¬¦ä¸²ï¼Œéç©º

**vals_data éªŒè¯**:
- æ‰€æœ‰å­—æ®µ: æ•´æ•°ï¼ŒèŒƒå›´ 1-5 (Likert 5ç‚¹é‡è¡¨)

**bfi_data éªŒè¯**:
- æ‰€æœ‰å­—æ®µ: æµ®ç‚¹æ•°ï¼ŒèŒƒå›´ 1.0-5.0 (Likert 5ç‚¹é‡è¡¨)



#### å“åº” (200 OK)
```json
{
  "status": "CURRENT_PROFILE_SAVED"
}
```

#### é”™è¯¯å“åº”

**400 Bad Request** - éªŒè¯å¤±è´¥
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "æ•°æ®éªŒè¯å¤±è´¥",
    "details": {
      "field": "vals_data.self_direction",
      "error": "å€¼å¿…é¡»åœ¨1-5ä¹‹é—´"
    }
  }
}
```

**400 Bad Request** - æ¡£æ¡ˆå·²å­˜åœ¨
```json
{
  "error": {
    "code": "PROFILE_ALREADY_EXISTS",
    "message": "å½“å‰æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œæ— æ³•é‡å¤åˆ›å»º"
  }
}
```

#### åç«¯å®ç°è¦ç‚¹
1. å°†3ä¸ªJSONå¯¹è±¡åˆ†åˆ«å­˜å…¥ `current_profiles` è¡¨çš„4ä¸ªç‹¬ç«‹å­—æ®µ
2. æ‰€æœ‰å­—æ®µå¿…é¡»åœ¨å­˜å‚¨å‰åŠ å¯†
3. éªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µå’Œæ•°æ®èŒƒå›´
4. ç”¨æˆ·çŠ¶æ€ä¿æŒä¸º `ONBOARDING` (ç­‰å¾… F2.2)

---

### 2.2 åˆ›å»ºæœªæ¥æ¡£æ¡ˆ (F2.2) 

**POST** `/profile/future`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- æäº¤3éƒ¨åˆ†æ–°é—®å·ï¼šä»·å€¼è§‚ã€æ„¿æ™¯ã€éšœç¢
- **V1æ ¸å¿ƒå¦¥å**: APIå±‚åŒæ­¥æ‹¼æ¥3ä¸ªå­—æ®µç”Ÿæˆ `profile_description`
- æœ€å¤šåˆ›å»º3ä¸ªæœªæ¥æ¡£æ¡ˆ
- å®Œæˆåæ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸º `ACTIVE`

#### è¯·æ±‚ä½“ (v1.5 å®Œæ•´ç‰ˆ)
```json
{
  "profiles": [
    {
      "profile_name": "UXç ”ç©¶å‘˜",
      "future_values": "æˆ‘å¸Œæœ›æˆ‘çš„å·¥ä½œèƒ½å¤ŸçœŸæ­£å¸®åŠ©åˆ°ä»–äººï¼Œè®©äº§å“æ›´åŠ äººæ€§åŒ–ã€‚æˆ‘ç›¸ä¿¡é€šè¿‡æ·±å…¥äº†è§£ç”¨æˆ·éœ€æ±‚ï¼Œå¯ä»¥åˆ›é€ å‡ºæ›´æœ‰æ„ä¹‰çš„äº§å“ä½“éªŒã€‚",
      "future_vision": "æˆ‘ç†æƒ³çš„çŠ¶æ€æ˜¯åœ¨ä¸€å®¶æ³¨é‡ç”¨æˆ·ä½“éªŒçš„ç§‘æŠ€å…¬å¸å·¥ä½œï¼Œé¢†å¯¼ä¸€ä¸ªå°å‹ç ”ç©¶å›¢é˜Ÿï¼Œä¸“æ³¨äºAIäº§å“çš„ç”¨æˆ·ä½“éªŒç ”ç©¶ã€‚æˆ‘å¸Œæœ›èƒ½å¤Ÿå¹³è¡¡å·¥ä½œä¸ç”Ÿæ´»ï¼ŒåŒæ—¶ä¿æŒå¯¹æ–°æŠ€æœ¯çš„å¥½å¥‡å¿ƒã€‚",
      "future_obstacles": "æˆ‘æ‹…å¿ƒæˆ‘çš„æŠ€æœ¯èƒŒæ™¯ä¸å¤Ÿæ‰å®ï¼Œå¯èƒ½åœ¨ä¸å·¥ç¨‹å¸ˆæ²Ÿé€šæ—¶é‡åˆ°å›°éš¾ã€‚åŒæ—¶ï¼Œæˆ‘ä¹Ÿæ‹…å¿ƒä»å­¦æœ¯ç•Œè½¬å‘å·¥ä¸šç•Œåï¼Œç ”ç©¶çš„æ·±åº¦ä¼šå—åˆ°å½±å“ã€‚"
    },
    {
      "profile_name": "ç»§ç»­è¯»åšçš„æˆ‘",
      "future_values": "æˆ‘å¸Œæœ›èƒ½å¤Ÿåœ¨å­¦æœ¯ç•Œåšå‡ºåŸåˆ›æ€§çš„è´¡çŒ®ï¼Œæ¨åŠ¨äººæœºäº¤äº’é¢†åŸŸçš„å‘å±•ã€‚",
      "future_vision": "æˆ‘ç†æƒ³çš„çŠ¶æ€æ˜¯æˆä¸ºä¸€ååŠ©ç†æ•™æˆï¼Œåœ¨é¡¶å°–é«˜æ ¡å»ºç«‹è‡ªå·±çš„å®éªŒå®¤...",
      "future_obstacles": "æˆ‘æ‹…å¿ƒå­¦æœ¯ç•Œçš„ç«äº‰å‹åŠ›å’Œä¸ç¡®å®šæ€§..."
    }
  ]
}
```

#### æ•°æ®éªŒè¯è§„åˆ™
- `profile_name`: å­—ç¬¦ä¸²ï¼Œ1-100å­—ç¬¦ï¼Œå¿…å¡«
- `future_values`: å­—ç¬¦ä¸²ï¼Œæœ€å°50å­—ç¬¦ï¼Œæœ€å¤§2000å­—ç¬¦ï¼Œå¿…å¡«
- `future_vision`: å­—ç¬¦ä¸²ï¼Œæœ€å°50å­—ç¬¦ï¼Œæœ€å¤§2000å­—ç¬¦ï¼Œå¿…å¡«
- `future_obstacles`: å­—ç¬¦ä¸²ï¼Œæœ€å°50å­—ç¬¦ï¼Œæœ€å¤§2000å­—ç¬¦ï¼Œå¿…å¡«
- `profiles` æ•°ç»„: æœ€å°‘1ä¸ªï¼Œæœ€å¤š3ä¸ª

#### å“åº” (200 OK)
```json
{
  "status": "ACTIVE",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "created_profiles": [
    {
      "future_profile_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "profile_name": "UXç ”ç©¶å‘˜"
    },
    {
      "future_profile_id": "8d0f7780-8536-51ef-a55c-f18gd2g01bf8",
      "profile_name": "ç»§ç»­è¯»åšçš„æˆ‘"
    }
  ]
}
```

#### é”™è¯¯å“åº”

**403 Forbidden** - è¶…è¿‡æ•°é‡é™åˆ¶
```json
{
  "error": {
    "code": "PROFILE_LIMIT_EXCEEDED",
    "message": "æœ€å¤šåªèƒ½åˆ›å»º3ä¸ªæœªæ¥æ¡£æ¡ˆ",
    "details": {
      "max_allowed": 3,
      "current_count": 3
    }
  }
}
```

#### åç«¯å®ç°è¦ç‚¹ (V1æ ¸å¿ƒå¦¥å)
1. éå† `profiles` æ•°ç»„
2. å¯¹æ¯ä¸ªprofile:
   - å­˜å‚¨åŸå§‹3ä¸ªå­—æ®µ: `future_values`, `future_vision`, `future_obstacles`
   - **åŒæ­¥æ‹¼æ¥**: `profile_description = future_values + "\n\n" + future_vision + "\n\n" + future_obstacles`
   - å­˜å‚¨æ‹¼æ¥åçš„ `profile_description` (P1 AIå°†åªè¯»è¿™ä¸ªå­—æ®µ)
3. å‘é‡åŒ– `profile_description` å¹¶å­˜å…¥ `vector_memory` è¡¨
4. æ›´æ–°ç”¨æˆ·çŠ¶æ€: `UPDATE users SET status='ACTIVE'`

---

## âœ‰ï¸ æ¨¡å—ä¸‰ï¼šä¿¡ä»¶äº¤äº’

### 3.1 æäº¤ä¿¡ä»¶ (F3.1.2) - å¼‚æ­¥

**POST** `/letters/submit`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- æäº¤ä¿¡ä»¶ï¼Œç«‹å³è¿”å›202
- æ¨é€å¼‚æ­¥ä»»åŠ¡åˆ°Worker
- Workerä¸ºæ‰€æœ‰æœªæ¥äººè®¾ç”Ÿæˆå›ä¿¡

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### è¯·æ±‚ä½“
```json
{
  "content": "äº²çˆ±çš„æœªæ¥çš„æˆ‘ï¼Œ\n\næˆ‘ç°åœ¨æ­£å¤„äºäººç”Ÿçš„åå­—è·¯å£ã€‚æˆ‘åœ¨æ€è€ƒæ˜¯å¦åº”è¯¥ç»§ç»­è¯»åšï¼Œè¿˜æ˜¯è¿›å…¥å·¥ä¸šç•Œã€‚æˆ‘å¯¹ç”¨æˆ·ç ”ç©¶å¾ˆæ„Ÿå…´è¶£ï¼Œä½†åˆæ‹…å¿ƒè‡ªå·±çš„æŠ€æœ¯èƒŒæ™¯ä¸å¤Ÿæ‰å®...\n\nï¼ˆå®Œæ•´ä¿¡ä»¶å†…å®¹ï¼Œ100-5000å­—ç¬¦ï¼‰"
}
```

#### æ•°æ®éªŒè¯
- `content`: å­—ç¬¦ä¸²ï¼Œæœ€å°50å­—ç¬¦ï¼Œæœ€å¤§5000å­—ç¬¦

#### å“åº” (202 Accepted)
```json
{
  "letter_id": "1a2b3c4d-5e6f-7g8h-9i10-j11k12l13m14",
  "status": "SUBMITTED"
}
```

#### å¼‚æ­¥å¤„ç†æµç¨‹
1. ç«‹å³è¿”å› 202
2. å­˜å‚¨ä¿¡ä»¶åˆ°æ•°æ®åº“ (`status = 'PENDING'`)
3. æ¨é€ `process_letter` ä»»åŠ¡åˆ°Redis
4. Workeræ‰§è¡Œ:
   - å‘é‡åŒ–ä¿¡ä»¶å†…å®¹
   - ä¸ºæ¯ä¸ªæœªæ¥äººè®¾ç”Ÿæˆå›ä¿¡ï¼ˆè°ƒç”¨F4.3 AIé“¾ï¼‰
   - å­˜å‚¨å›ä¿¡åˆ° `letter_replies` è¡¨
   - æ›´æ–°ä¿¡ä»¶çŠ¶æ€: `status = 'REPLIES_READY'`

---

### 3.2 æ£€æŸ¥å›ä¿¡çŠ¶æ€ (F6.6) - è½®è¯¢

**GET** `/letters/status`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- å‰ç«¯è½®è¯¢æ­¤æ¥å£ï¼ˆ3-5ç§’é—´éš”ï¼‰
- æ£€æŸ¥å›ä¿¡æ˜¯å¦ç”Ÿæˆå®Œæˆ

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### å“åº” (200 OK)

**ç”Ÿæˆä¸­**
```json
{
  "status": "PENDING"
}
```

**å·²å®Œæˆ**
```json
{
  "status": "REPLIES_READY"
}
```

#### å‰ç«¯è½®è¯¢ç­–ç•¥
```javascript
// ä¼ªä»£ç 
async function pollLetterStatus(userId) {
  const maxAttempts = 60; // 3åˆ†é’Ÿ (60 * 3ç§’)
  let attempts = 0;
  
  while (attempts < maxAttempts) {
    const response = await fetch(`/letters/status?user_id=${userId}`);
    const data = await response.json();
    
    if (data.status === 'REPLIES_READY') {
      return true; // è·³è½¬åˆ°æ”¶ä¿¡ç®±
    }
    
    await sleep(3000); // ç­‰å¾…3ç§’
    attempts++;
  }
  
  throw new Error('è¶…æ—¶');
}
```

---

### 3.3 è·å–æ”¶ä¿¡ç®± (F6.5)

**GET** `/inbox/latest`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- è·å–æœ€æ–°ä¿¡ä»¶å’Œæ‰€æœ‰å›ä¿¡åˆ—è¡¨
- åŒ…å«æ¯ä¸ªå›ä¿¡çš„ `chat_status`

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### å“åº” (200 OK)
```json
{
  "letter_id": "1a2b3c4d-5e6f-7g8h-9i10-j11k12l13m14",
  "letter_content_snippet": "äº²çˆ±çš„æœªæ¥çš„æˆ‘ï¼Œæˆ‘ç°åœ¨æ­£å¤„äºäººç”Ÿçš„åå­—è·¯å£...",
  "replies": [
    {
      "reply_id": "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6",
      "future_profile_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "from_profile_name": "UXç ”ç©¶å‘˜",
      "chat_status": "NOT_STARTED"
    },
    {
      "reply_id": "q6r7s8t9-u0v1-w2x3-y4z5-a6b7c8d9e0f1",
      "future_profile_id": "8d0f7780-8536-51ef-a55c-f18gd2g01bf8",
      "from_profile_name": "ç»§ç»­è¯»åš",
      "chat_status": "COMPLETED"
    }
  ]
}
```

#### å­—æ®µè¯´æ˜
- `letter_content_snippet`: ä¿¡ä»¶å‰100å­— + "..."
- `chat_status`: 
  - `NOT_STARTED` - æœªå¼€å§‹èŠå¤©ï¼Œæ˜¾ç¤º"æŸ¥çœ‹å›ä¿¡"æŒ‰é’®
  - `COMPLETED` - å·²å®Œæˆ5æ¡æ¶ˆæ¯ï¼Œç¦ç”¨èŠå¤©æŒ‰é’®

---

### 3.4 è·å–å•å°å›ä¿¡ (F3.1.3)

**GET** `/letters/reply/{reply_id}`

#### åŠŸèƒ½æè¿°
- P0 æ ¸å¿ƒåŠŸèƒ½
- æŸ¥çœ‹å®Œæ•´å›ä¿¡å†…å®¹
- åŒ…å« `chat_status` ç”¨äºå‰ç«¯åˆ¤æ–­æ˜¯å¦å¯å¼€å§‹èŠå¤©

#### Path Parameters
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| reply_id | UUID | å›ä¿¡UUID |

#### å“åº” (200 OK)
```json
{
  "reply_id": "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6",
  "future_profile_id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "from_profile_name": "UXç ”ç©¶å‘˜",
  "content": "äº²çˆ±çš„è¿‡å»çš„æˆ‘ï¼Œ\n\næˆ‘è®°å¾—ä½ ç°åœ¨çš„æ„Ÿå—ï¼Œé‚£ç§ç«™åœ¨åå­—è·¯å£çš„è¿·èŒ«å’Œä¸å®‰ã€‚æˆ‘æƒ³å‘Šè¯‰ä½ ï¼Œä½ ç°åœ¨æ‰€æ‹…å¿ƒçš„æŠ€æœ¯èƒŒæ™¯é—®é¢˜ï¼Œåœ¨æœªæ¥å¹¶æ²¡æœ‰æˆä¸ºçœŸæ­£çš„éšœç¢...\n\nï¼ˆå®Œæ•´å›ä¿¡å†…å®¹ï¼‰",
  "chat_status": "NOT_STARTED"
}
```

#### é”™è¯¯å“åº”

**404 Not Found**
```json
{
  "error": {
    "code": "REPLY_NOT_FOUND",
    "message": "å›ä¿¡ä¸å­˜åœ¨"
  }
}
```

---

## ğŸ’¬ æ¨¡å—å››ï¼šèŠå¤©äº¤äº’

### 4.1 è·å–èŠå¤©å†å² (F3.2.3)

**GET** `/chat/{future_profile_id}/history`

#### åŠŸèƒ½æè¿°
- P1 æ ¸å¿ƒåŠŸèƒ½
- åŠ è½½ä¸æŒ‡å®šæœªæ¥äººè®¾çš„èŠå¤©è®°å½•
- æŒ‰æ—¶é—´æ­£åºæ’åˆ—

#### Path Parameters
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| future_profile_id | UUID | æœªæ¥æ¡£æ¡ˆUUID |

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### å“åº” (200 OK)
```json
[
  {
    "message_id": "m1a2b3c4-d5e6-f7g8-h9i0-j1k2l3m4n5o6",
    "sender": "USER",
    "content": "ä½ å¥½ï¼Œæœªæ¥çš„æˆ‘",
    "created_at": "2024-11-09T10:30:00Z"
  },
  {
    "message_id": "m2p7q8r9-s0t1-u2v3-w4x5-y6z7a8b9c0d1",
    "sender": "AGENT",
    "content": "ä½ å¥½ï¼Œè¿‡å»çš„æˆ‘ã€‚æˆ‘å¾ˆé«˜å…´èƒ½å’Œä½ å¯¹è¯ã€‚",
    "created_at": "2024-11-09T10:30:05Z"
  }
]
```

---

### 4.2 å‘é€èŠå¤©æ¶ˆæ¯ (F3.2.2) - åŒæ­¥ + 5æ¡é™åˆ¶

**POST** `/chat/{future_profile_id}/send`

#### åŠŸèƒ½æè¿°
- P1 æ ¸å¿ƒåŠŸèƒ½
- **å…³é”®é™åˆ¶**: æ¯ä¸ªæœªæ¥äººè®¾æœ€å¤š5æ¡ç”¨æˆ·æ¶ˆæ¯
- åŒæ­¥è°ƒç”¨AIï¼ˆ< 8ç§’ SLAï¼‰
- ç¬¬5æ¡æ¶ˆæ¯åè‡ªåŠ¨è§¦å‘F5.1æŠ¥å‘Šç”Ÿæˆ

#### Path Parameters
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| future_profile_id | UUID | æœªæ¥æ¡£æ¡ˆUUID |

#### è¯·æ±‚ä½“
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "content": "ä½ å¯¹æˆ‘çš„æ‹…å¿§æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ"
}
```

#### æ•°æ®éªŒè¯
- `content`: å­—ç¬¦ä¸²ï¼Œæœ€å°1å­—ç¬¦ï¼Œæœ€å¤§1000å­—ç¬¦

#### å“åº” (201 Created) - æ¶ˆæ¯1-5

```json
{
  "message_id": "m3x4y5z6-a7b8-c9d0-e1f2-g3h4i5j6k7l8",
  "sender": "AGENT",
  "content": "å…³äºä½ çš„æ‹…å¿§ï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼šé¦–å…ˆï¼ŒæŠ€æœ¯èƒŒæ™¯å¯ä»¥é€šè¿‡å­¦ä¹ è¡¥è¶³ï¼Œä½†å¯¹ç”¨æˆ·çš„åŒç†å¿ƒå’Œç ”ç©¶èƒ½åŠ›æ˜¯æ›´éš¾åŸ¹å…»çš„ã€‚ä½ çš„è®¡ç®—æœºèƒŒæ™¯åè€Œæ˜¯ä¼˜åŠ¿...",
  "created_at": "2024-11-09T10:35:10Z"
}
```

#### é”™è¯¯å“åº” (403 Forbidden) - æ¶ˆæ¯6+

```json
{
  "error": {
    "code": "MESSAGE_LIMIT_EXCEEDED",
    "message": "æ‚¨å·²è¾¾åˆ°5æ¡æ¶ˆæ¯çš„é™åˆ¶",
    "details": {
      "max_messages": 5,
      "current_count": 5
    }
  }
}
```

#### ä¸šåŠ¡é€»è¾‘
1. æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯æ•°é‡ (`sender='USER'`)
2. å¦‚æœ >= 5æ¡ â†’ è¿”å›403
3. å¦‚æœ < 5æ¡:
   - å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯
   - è°ƒç”¨F4.4 AIé“¾ï¼ˆRAGæ£€ç´¢ + LLMç”Ÿæˆï¼‰
   - å­˜å‚¨AIå›å¤
   - å¦‚æœè¿™æ˜¯ç¬¬5æ¡ â†’ æ›´æ–° `letter_replies.chat_status = 'COMPLETED'`

#### æ€§èƒ½è¦æ±‚
- SLA: < 8ç§’å“åº”æ—¶é—´
- è¶…æ—¶: è¿”å› 504 Gateway Timeout

---

## ğŸ“Š æ¨¡å—äº”ï¼šæŠ¥å‘Šç”Ÿæˆ

### 5.1 è§¦å‘æŠ¥å‘Šç”Ÿæˆ (F5.1) - å¼‚æ­¥

**POST** `/report/generate`

#### åŠŸèƒ½æè¿°
- P1 æ ¸å¿ƒåŠŸèƒ½
- ç”±å‰ç«¯åœ¨ç¬¬5æ¡æ¶ˆæ¯åè‡ªåŠ¨è§¦å‘
- å¼‚æ­¥ç”ŸæˆWOOPæ¡†æ¶çš„èŒä¸šæ´è§æŠ¥å‘Š

#### è¯·æ±‚ä½“
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### å“åº” (202 Accepted)
```json
{
  "report_id": "r1s2t3u4-v5w6-x7y8-z9a0-b1c2d3e4f5g6",
  "status": "GENERATING",
  "message": "æŠ¥å‘Šç”Ÿæˆå·²å¼€å§‹"
}
```

#### å¼‚æ­¥å¤„ç†æµç¨‹
1. ç«‹å³è¿”å› 202
2. åˆ›å»ºæŠ¥å‘Šè®°å½• (`status = 'GENERATING'`)
3. æ¨é€ `generate_report` ä»»åŠ¡åˆ°Redis
4. Workeræ‰§è¡Œ:
   - åŠ è½½å®Œæ•´èŠå¤©è®°å½•
   - è°ƒç”¨F4.5 AIé“¾ç”ŸæˆWOOPæŠ¥å‘Š
   - æ›´æ–°æŠ¥å‘ŠçŠ¶æ€: `status = 'READY'`

---

### 5.2 æ£€æŸ¥æŠ¥å‘ŠçŠ¶æ€ (F5.3) - è½®è¯¢

**GET** `/report/status`

#### åŠŸèƒ½æè¿°
- P1 æ ¸å¿ƒåŠŸèƒ½
- å‰ç«¯è½®è¯¢æ­¤æ¥å£ï¼ˆ5ç§’é—´éš”ï¼‰
- æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦ç”Ÿæˆå®Œæˆ

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### å“åº” (200 OK)

**ç”Ÿæˆä¸­**
```json
{
  "status": "GENERATING"
}
```

**å·²å®Œæˆ**
```json
{
  "status": "READY"
}
```

---

### 5.3 è·å–æŠ¥å‘Š (F5.2)

**GET** `/report/latest`

#### åŠŸèƒ½æè¿°
- P1 æ ¸å¿ƒåŠŸèƒ½
- è·å–WOOPæ¡†æ¶çš„èŒä¸šæ´è§æŠ¥å‘Š
- åªè¿”å›çŠ¶æ€ä¸ºREADYçš„æŠ¥å‘Š

#### Query Parameters
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| user_id | string | æ˜¯ | ç”¨æˆ·UUID |

#### å“åº” (200 OK)
```json
{
  "report_id": "r1s2t3u4-v5w6-x7y8-z9a0-b1c2d3e4f5g6",
  "status": "READY",
  "content": {
    "W": "ä½ çš„æ„¿æœ›æ˜¯æˆä¸ºä¸€åä¼˜ç§€çš„UXç ”ç©¶å‘˜ï¼Œå¸Œæœ›èƒ½å¤Ÿé€šè¿‡æ·±å…¥çš„ç”¨æˆ·ç ”ç©¶æ¥å½±å“äº§å“è®¾è®¡ï¼Œåˆ›é€ æ›´æœ‰æ„ä¹‰çš„ç”¨æˆ·ä½“éªŒã€‚",
    "O": "ç†æƒ³çš„ç»“æœæ˜¯ï¼Œä½ èƒ½å¤Ÿåœ¨3å¹´å†…æˆä¸ºå›¢é˜Ÿçš„æ ¸å¿ƒæˆå‘˜ï¼Œé¢†å¯¼é‡è¦çš„ç ”ç©¶é¡¹ç›®ï¼Œå¹¶åœ¨å·¥ä½œä¸ç”Ÿæ´»ä¹‹é—´æ‰¾åˆ°è‰¯å¥½çš„å¹³è¡¡ã€‚ä½ å¸Œæœ›è¢«è®¤å¯ä¸ºæ—¢æ‡‚æŠ€æœ¯åˆæ‡‚ç”¨æˆ·çš„è·¨ç•Œäººæ‰ã€‚",
    "O": "ä¸»è¦çš„éšœç¢åŒ…æ‹¬ï¼š1) å¯¹æŠ€æœ¯èƒŒæ™¯ä¸å¤Ÿæ‰å®çš„æ‹…å¿§ï¼Œå®³æ€•åœ¨ä¸å·¥ç¨‹å¸ˆæ²Ÿé€šæ—¶é‡åˆ°å›°éš¾ 2) å¯¹ä»å­¦æœ¯ç•Œè½¬å‘å·¥ä¸šç•Œåç ”ç©¶æ·±åº¦å¯èƒ½ä¸‹é™çš„é¡¾è™‘ 3) èŒä¸šè½¬æ¢æœŸçš„ä¸ç¡®å®šæ„Ÿå’Œè‡ªæˆ‘æ€€ç–‘ã€‚",
    "P": "ä½ çš„è¡ŒåŠ¨è®¡åˆ’åŒ…æ‹¬ï¼š1) æŠ¥åå‚åŠ UXä¸“ä¸šè¯¾ç¨‹ï¼Œç³»ç»Ÿå­¦ä¹ ç”¨æˆ·ç ”ç©¶æ–¹æ³•è®º 2) åœ¨å½“å‰é¡¹ç›®ä¸­ä¸»åŠ¨æ‰¿æ‹…ç”¨æˆ·ç ”ç©¶ç›¸å…³ä»»åŠ¡ï¼Œç§¯ç´¯å®è·µç»éªŒ 3) å»ºç«‹ä¸ªäººä½œå“é›†ï¼Œè®°å½•ç ”ç©¶æ¡ˆä¾‹ 4) åŠ å…¥UXç¤¾ç¾¤ï¼Œå»ºç«‹äººè„‰ç½‘ç»œ 5) ä¿æŒå¯¹æ–°æŠ€æœ¯çš„å­¦ä¹ ï¼Œå°†æŠ€æœ¯èƒŒæ™¯è½¬åŒ–ä¸ºä¼˜åŠ¿è€ŒéåŠ£åŠ¿ã€‚"
  },
  "created_at": "2024-11-09T11:00:00Z"
}
```

#### WOOPæ¡†æ¶è¯´æ˜
- **W (Wish)**: æ„¿æœ› - ç”¨æˆ·çš„æ ¸å¿ƒèŒä¸šç›®æ ‡
- **O (Outcome)**: ç»“æœ - å®ç°æ„¿æœ›åçš„ç†æƒ³çŠ¶æ€
- **O (Obstacle)**: éšœç¢ - é˜»ç¢å®ç°æ„¿æœ›çš„å†…å¤–éƒ¨å› ç´ 
- **P (Plan)**: è®¡åˆ’ - å…·ä½“å¯æ‰§è¡Œçš„è¡ŒåŠ¨æ­¥éª¤

#### é”™è¯¯å“åº”

**404 Not Found** - æ— å¯ç”¨æŠ¥å‘Š
```json
{
  "error": {
    "code": "REPORT_NOT_FOUND",
    "message": "æš‚æ— å¯ç”¨æŠ¥å‘Š"
  }
}
```

---

## âš ï¸ é”™è¯¯ç å‚è€ƒ

### ç”¨æˆ·ç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| INVALID_USER_ID | 400 | ç”¨æˆ·IDæ ¼å¼æ— æ•ˆ |
| USER_NOT_FOUND | 404 | ç”¨æˆ·ä¸å­˜åœ¨ |

### æ¡£æ¡ˆç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| VALIDATION_ERROR | 400 | æ•°æ®éªŒè¯å¤±è´¥ |
| PROFILE_ALREADY_EXISTS | 400 | æ¡£æ¡ˆå·²å­˜åœ¨ |
| PROFILE_INCOMPLETE | 400 | æ¡£æ¡ˆä¿¡æ¯ä¸å®Œæ•´ |
| PROFILE_LIMIT_EXCEEDED | 403 | è¶…è¿‡æœªæ¥æ¡£æ¡ˆæ•°é‡é™åˆ¶(3ä¸ª) |

### ä¿¡ä»¶ç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| LETTER_NOT_FOUND | 404 | ä¿¡ä»¶ä¸å­˜åœ¨ |
| REPLY_NOT_FOUND | 404 | å›ä¿¡ä¸å­˜åœ¨ |
| LETTER_TOO_SHORT | 400 | ä¿¡ä»¶å†…å®¹è¿‡çŸ­(<50å­—) |
| LETTER_TOO_LONG | 400 | ä¿¡ä»¶å†…å®¹è¿‡é•¿(>5000å­—) |

### èŠå¤©ç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| MESSAGE_LIMIT_EXCEEDED | 403 | è¶…è¿‡èŠå¤©æ¶ˆæ¯é™åˆ¶(5æ¡) |
| FUTURE_PROFILE_NOT_FOUND | 404 | æœªæ¥æ¡£æ¡ˆä¸å­˜åœ¨ |

### æŠ¥å‘Šç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| REPORT_NOT_FOUND | 404 | æŠ¥å‘Šä¸å­˜åœ¨ |
| REPORT_GENERATING | 425 | æŠ¥å‘Šç”Ÿæˆä¸­ï¼Œè¯·ç¨å |

### ç³»ç»Ÿç›¸å…³
| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ |
|--------|----------|------|
| LLM_TIMEOUT | 504 | AIæœåŠ¡è¶…æ—¶ |
| LLM_ERROR | 500 | AIæœåŠ¡é”™è¯¯ |
| INTERNAL_ERROR | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## ğŸ”„ å®Œæ•´ç”¨æˆ·æ—…ç¨‹ç¤ºä¾‹

### æ­¥éª¤1: åˆå§‹åŒ–ç”¨æˆ·
```http
POST /api/v1/user/init
Content-Type: application/json

{
  "anonymous_user_id": null
}

â†’ Response: { "user_id": "xxx", "status": "ONBOARDING" }
```

### æ­¥éª¤2: æäº¤å½“å‰æ¡£æ¡ˆ (F2.1)
```http
POST /api/v1/profile/current?user_id=xxx
Content-Type: application/json

{
  "demo_data": { ... },
  "vals_data": { ... },
  "bfi_data": { ... },
  "story_data": { ... }
}

â†’ Response: { "status": "CURRENT_PROFILE_SAVED" }
```

### æ­¥éª¤3: åˆ›å»ºæœªæ¥æ¡£æ¡ˆ (F2.2)
```http
POST /api/v1/profile/future?user_id=xxx
Content-Type: application/json

{
  "profiles": [
    {
      "profile_name": "UXç ”ç©¶å‘˜",
      "future_values": "...",
      "future_vision": "...",
      "future_obstacles": "..."
    }
  ]
}

â†’ Response: { "status": "ACTIVE", "created_profiles": [...] }
```

### æ­¥éª¤4: æäº¤ä¿¡ä»¶ (F3.1.2)
```http
POST /api/v1/letters/submit?user_id=xxx
Content-Type: application/json

{
  "content": "äº²çˆ±çš„æœªæ¥çš„æˆ‘..."
}

â†’ Response: { "letter_id": "yyy", "status": "SUBMITTED" }
```

### æ­¥éª¤5: è½®è¯¢å›ä¿¡çŠ¶æ€ (F6.6)
```http
GET /api/v1/letters/status?user_id=xxx

â†’ Response: { "status": "REPLIES_READY" }
```

### æ­¥éª¤6: æŸ¥çœ‹æ”¶ä¿¡ç®± (F6.5)
```http
GET /api/v1/inbox/latest?user_id=xxx

â†’ Response: { "letter_id": "yyy", "replies": [...] }
```

### æ­¥éª¤7: é˜…è¯»å›ä¿¡ (F3.1.3)
```http
GET /api/v1/letters/reply/{reply_id}

â†’ Response: { "content": "...", "chat_status": "NOT_STARTED" }
```

### æ­¥éª¤8: å‘é€èŠå¤©æ¶ˆæ¯ (F3.2.2) x5
```http
POST /api/v1/chat/{future_profile_id}/send
Content-Type: application/json

{
  "user_id": "xxx",
  "content": "ä½ å¥½ï¼Œæœªæ¥çš„æˆ‘"
}

â†’ Response: { "sender": "AGENT", "content": "..." }
```

### æ­¥éª¤9: ç¬¬5æ¡æ¶ˆæ¯åï¼Œå‰ç«¯è‡ªåŠ¨è§¦å‘æŠ¥å‘Š (F5.1)
```http
POST /api/v1/report/generate
Content-Type: application/json

{
  "user_id": "xxx"
}

â†’ Response: { "status": "GENERATING" }
```

### æ­¥éª¤10: è½®è¯¢æŠ¥å‘ŠçŠ¶æ€ (F5.3)
```http
GET /api/v1/report/status?user_id=xxx

â†’ Response: { "status": "READY" }
```

### æ­¥éª¤11: æŸ¥çœ‹æŠ¥å‘Š (F5.2)
```http
GET /api/v1/report/latest?user_id=xxx

â†’ Response: { "content": { "W": "...", "O": "...", ... } }
```

---

## ğŸ“Œ APIè®¾è®¡åŸåˆ™

### 1. å¼‚æ­¥ä¼˜å…ˆ
- è€—æ—¶æ“ä½œï¼ˆAIç”Ÿæˆï¼‰ä½¿ç”¨å¼‚æ­¥æ¨¡å¼
- ç«‹å³è¿”å› 202 Accepted
- æä¾›è½®è¯¢æ¥å£æŸ¥è¯¢çŠ¶æ€

### 2. å¹‚ç­‰æ€§
- GETè¯·æ±‚å¤©ç„¶å¹‚ç­‰
- POSTè¯·æ±‚åœ¨åˆç†æƒ…å†µä¸‹æ”¯æŒé‡å¤æäº¤

### 3. æ•°æ®å®‰å…¨
- æ‰€æœ‰PIIæ•°æ®å¿…é¡»åŠ å¯†å­˜å‚¨
- APIä¼ è¾“ä½¿ç”¨HTTPS
- éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥

### 4. æ€§èƒ½è¦æ±‚
- åŒæ­¥èŠå¤©: < 8ç§’
- å¼‚æ­¥å›ä¿¡: < 5åˆ†é’Ÿ
- å¼‚æ­¥æŠ¥å‘Š: < 3åˆ†é’Ÿ

### 5. é”™è¯¯å¤„ç†
- æä¾›æ¸…æ™°çš„é”™è¯¯ç 
- åŒ…å«å¯æ“ä½œçš„é”™è¯¯ä¿¡æ¯
- åŒºåˆ†å®¢æˆ·ç«¯é”™è¯¯å’ŒæœåŠ¡ç«¯é”™è¯¯

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### ç¯å¢ƒå˜é‡
```env
# APIé…ç½®
API_BASE_URL=http://localhost:8000
API_VERSION=v1

# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost:5432/future_self_db

# Redis
REDIS_URL=redis://localhost:6379/0

# AIæœåŠ¡
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# é™æµ
MAX_CHAT_MESSAGES=5
MAX_FUTURE_PROFILES=3
```

### æµ‹è¯•API
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# APIæ–‡æ¡£
open http://localhost:8000/docs
```


---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.5  
**æœ€åæ›´æ–°**: 2025-11-10  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
